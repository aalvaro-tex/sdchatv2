<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>sdChat - Mi perfil</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="#{resource['css/user-page.css']}"></link>
        <link rel="icon" type="image/x-icon" href="#{resource['icon/sdChat-favicon.png']}"></link>
        <style>
            .card { max-width: 520px; margin: 0 auto; }
            .avatar-section { display:flex; flex-direction:column; align-items:center; gap:.5rem; }
            .avatar, .avatar.fallback {
                width:112px; height:112px; border-radius:50%; object-fit:cover;
                display:flex; align-items:center; justify-content:center;
                background:#E5E7EB; font-weight:700; font-size:32px; color:#374151;
            }
            .preview-card { margin-top:1rem; border-radius:14px; padding:1rem; }
            .preview-controls{ display:flex; gap:.5rem; margin-top:.5rem; }
            .pill{ border:1px solid; padding:.25rem .5rem; border-radius:999px; font-weight:600; font-size:.8rem; background: rgba(255,255,255,.15);}
            .btn-ghost{ border:1px solid; padding:.4rem .6rem; border-radius:10px; font-weight:600; font-size:.9rem; }
            .actions{ display:flex; gap:.75rem; margin-top:1rem; }
            #form\\:save { color:#fff; } /* asegura texto blanco en botón guardar */
        </style>
        <style>
            .square .clr-field button, .circle .clr-field button {
                width: 22px;
                height: 22px;
                left: 5px;
                right: auto;
                border-radius: 5px;
            }

            .square .clr-field input, .circle .clr-field input {
                padding-left: 36px;
            }

            .circle .clr-field button {
                border-radius: 50%;
            }
        </style>
        <style>
            /* --- avatar grande --- */

            .avatar-circle{
                width:100%; height:100%; border-radius:50%;
                overflow:hidden; border:3px solid #0b3a4a;                 /* contorno oscuro */
                background:#1b5f75;                                        /* color de fondo si no hay foto */
                display:flex; align-items:center; justify-content:center;
            }
            .avatar-circle img{ width:100%; height:100%; object-fit:cover; display:block; }

            /* --- botón redondo superpuesto --- */
            .edit-fab{
                position:absolute; right:6px; bottom:6px;                   /* esquina inferior derecha */
                width:56px; height:56px; border-radius:50%;
                border:3px solid #0b3a4a;                                   /* contorno como el del avatar */
                display:flex; align-items:center; justify-content:center;
                box-shadow:0 2px 6px rgba(0,0,0,.25);
            }
            /* fuerza el rojo y redondeado de PrimeFaces */
            .p-button.edit-fab{ background:#e70000; border-color:#e70000; }
            .p-button.edit-fab .pi{ font-size:1.25rem; color:#fff; }
        </style>
    </h:head>

    <h:body>
        <f:metadata>
            <f:viewParam name="user" value="#{userBackingBean.idUsuarioLogeado}" />
            <f:event type="preRenderView" listener="#{userBackingBean.onPreRenderView}"/>
        </f:metadata>
        <div class="chat-list-container" >
            <div class="chat-list-title">
                <h:form>
                    <div class="buttons-container">
                        <p:linkButton id="backButton" styleClass="rounded-button ui-button-flat" icon="pi pi-chevron-left" outcome="/chat/chat.xhtml"></p:linkButton>

                        <p:tooltip for="backButton" value="Volver a mis chats" position="right"/>
                    </div>
                </h:form>
                <h:form>
                    <p:commandButton value="Guardar cambios" id="saveBtn" styleClass="rounded-button ui-button-primary" action="#{userClientBean.saveChanges()}" update="growlUpdate" >
                        <p:ajax event="click" update="form"></p:ajax>
                    </p:commandButton>

                    <p:growl id="growlUpdate" showDetail="true"/>
                </h:form>


            </div>
            <p:divider align="left">
                <div class="inline-flex align-items-center">
                    <i class="pi pi-id-card" id="divider-icon"/>
                    <b>Mis datos</b>
                </div>
            </p:divider>
            <!--
            <div class="field col-12 md:col-2 thumbnail">
                <p:outputLabel for="@next" value="Color preferente" />
                <p:colorPicker  id="thumbnail" value="#{userBackingBean.colorPreferente}">
                </p:colorPicker>
            </div>
            -->
            <h:form id="form" style="display:flex;">
                <p:ajaxStatus 
                    onstart="PF('loadingDialog').show()" 
                    onsuccess="PF('loadingDialog').hide()"/>

                <!-- MODAL CENTRADO CON SPINNER -->
                <p:dialog id="dlgLoading"
                          widgetVar="loadingDialog"
                          modal="true"
                          closable="false"
                          draggable="false"
                          resizable="false"
                          showHeader="false"
                          appendTo="@(body)"
                          width="100"
                          >

                    <div style="text-align:center; padding-top:30px;">
                        <i class="pi pi-spin pi-spinner" style="font-size:2rem;"></i>
                    </div>
                </p:dialog>
                <!-- Contenedor avatar + botón -->
                <div class="avatar-wrap">
                    <!-- Imagen circular -->
                    <div class="avatar-circle">
                        <!-- Si tienes bytes en el bean -->
                        <img id="avatarImg" src="data:image/png;base64,#{userBackingBean.fotoPerfilSrc}"/>
                        <!-- Fallback si no hay imagen -->
                        <h:panelGroup rendered="#{empty userBackingBean.fotoPerfilSrc}">
                            <span style="color:#dbe5ea; font-weight:700; font-size:2rem;">
                                NE
                            </span>
                        </h:panelGroup>
                    </div>

                    <!-- Botón circular pequeño (abre el diálogo de subir imagen) -->
                    <p:commandButton type="button" icon="pi pi-pencil"
                                     onclick="PF('uploadDlg').show()"
                                     styleClass="rounded-button ui-button-info edit-fab" id="editPicBtn"/>
                    <p:tooltip for="editPicBtn" value="Cambiar imagen de perfil" position="right"/>
                </div>
                <div class="info-container">

                </div>


                <!-- Diálogo con fileUpload -->
                <p:dialog widgetVar="uploadDlg" header="Cambiar imagen de perfil" modal="true"
                          resizable="false" draggable="false">
                    <div class="btn-container">
                        <p:fileUpload auto="true" style="margin-top:10px; align-self: center" label="Seleccionar imagen" process="@this" id="upload" value="#{userBackingBean.fotoPerfil}" mode="simple" skinSimple="true" 
                                      oncomplete="PF('uploadDlg').hide()" update="form"/>
                    </div>
                </p:dialog>


            </h:form>
        </div>
    </h:body>
</html>