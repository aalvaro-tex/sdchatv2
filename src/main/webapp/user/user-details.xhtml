<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>sdChat - Mi perfil</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="#{resource['css/user-page.css']}"></link>
        <link rel="icon" type="image/x-icon" href="#{resource['icon/logo_sdChat_v2.png']}"></link>
        <style>
            .card { max-width: 520px; margin: 0 auto; }
            .avatar-section { display:flex; flex-direction:column; align-items:center; gap:.5rem; }
            .avatar, .avatar.fallback {
                width:112px; height:112px; border-radius:50%; object-fit:cover;
                display:flex; align-items:center; justify-content:center;
                background:#E5E7EB; font-weight:700; font-size:32px; color:#374151;
            }
            .preview-card { margin-top:1rem; border-radius:14px; padding:1rem; }
            .preview-controls{ display:flex; gap:.5rem; margin-top:.5rem; }
            .pill{ border:1px solid; padding:.25rem .5rem; border-radius:999px; font-weight:600; font-size:.8rem; background: rgba(255,255,255,.15);}
            .btn-ghost{ border:1px solid; padding:.4rem .6rem; border-radius:10px; font-weight:600; font-size:.9rem; }
            .actions{ display:flex; gap:.75rem; margin-top:1rem; }
            #form\\:save { color:#fff; } /* asegura texto blanco en bot√≥n guardar */
        </style>
        <style>
            .square .clr-field button, .circle .clr-field button {
                width: 22px;
                height: 22px;
                left: 5px;
                right: auto;
                border-radius: 5px;
            }

            .square .clr-field input, .circle .clr-field input {
                padding-left: 36px;
            }

            .circle .clr-field button {
                border-radius: 50%;
            }
        </style>
         <h:outputStylesheet library="css" name="themes/dark.css" rendered="#{loginBackingBean.temaUsuario == 'dark'}"/>
         <h:outputStylesheet library="css" name="themes/green.css" rendered="#{loginBackingBean.temaUsuario == 'green'}"/>
         <h:outputStylesheet library="css" name="themes/pink.css" rendered="#{loginBackingBean.temaUsuario == 'pink'}"/>
    </h:head>

    <h:body>
        <f:metadata>
            <f:viewParam name="user" value="#{userBackingBean.idUsuarioLogeado}" />
            <f:event type="preRenderView" listener="#{userBackingBean.onPreRenderView}"/>
        </f:metadata>
        <div class="user-settings-container" >
            <div class="user-settings-title">
                <h:form>
                    <div class="buttons-container">
                        <p:linkButton id="backButton" styleClass="rounded-button ui-button-flat" icon="pi pi-chevron-left" outcome="/chat/chat.xhtml">
                            <f:param name="idConversacion" value="0-0"/>
                            <f:param name="user" value="#{chatBackingBean.idUserLogeado}"/>
                        </p:linkButton>

                        <p:tooltip for="backButton" value="Volver a mis chats" position="right"/>
                    </div>
                </h:form>
                <h:form>
                    <p:commandButton value="Guardar cambios" id="saveBtn" styleClass="rounded-button ui-button-primary" action="#{userClientBean.saveChanges()}" update="growlUpdate" >
                        <p:ajax event="click" update="form"></p:ajax>
                    </p:commandButton>

                    <p:growl id="growlUpdate" showDetail="true"/>
                </h:form>


            </div>
            <p:divider align="left">
                <div class="inline-flex align-items-center">
                    <i class="pi pi-id-card" id="divider-icon"/>
                    <b>Mi foto de perfil</b>
                </div>
            </p:divider>

            

            <h:form id="form" style="display:flex;">
                <p:ajaxStatus 
                    onstart="PF('loadingDialog').show()" 
                    onsuccess="PF('loadingDialog').hide()"/>

                <!-- MODAL CENTRADO CON SPINNER -->
                <p:dialog id="dlgLoading"
                          widgetVar="loadingDialog"
                          modal="true"
                          closable="false"
                          draggable="false"
                          resizable="false"
                          showHeader="false"
                          appendTo="@(body)"
                          width="100"
                          >

                    <div style="text-align:center; padding-top:30px;">
                        <i class="pi pi-spin pi-spinner" style="font-size:2rem;"></i>
                    </div>
                </p:dialog>
  
                <div class="avatar-wrap">
                    <div class="avatar-circle">
                        <img id="avatarImg" src="data:image/png;base64,#{userBackingBean.fotoPerfilSrc}"/>
                        <h:panelGroup rendered="#{empty userBackingBean.fotoPerfilSrc}">
                            <span style="color:#dbe5ea; font-weight:700; font-size:2rem;">
                                NE
                            </span>
                        </h:panelGroup>
                    </div>

                   
                    <p:commandButton type="button" icon="pi pi-pencil"
                                     onclick="PF('uploadDlg').show()"
                                     styleClass="rounded-button ui-button-info edit-fab" id="editPicBtn"/>
                    <p:tooltip for="editPicBtn" value="Cambiar imagen de perfil" position="right"/>
                </div>
                <div class="info-container">

                </div>


                
                <p:dialog widgetVar="uploadDlg" header="Cambiar imagen de perfil" modal="true"
                          resizable="false" draggable="false">
                    <div class="btn-container">
                        <p:fileUpload auto="true" style="margin-top:10px; align-self: center" label="Seleccionar imagen" process="@this" id="upload" value="#{userBackingBean.fotoPerfil}" mode="simple" skinSimple="true" 
                                      oncomplete="PF('uploadDlg').hide()" update="form"/>
                    </div>
                </p:dialog>


            </h:form>
            <p:divider align="left">
                <div class="inline-flex align-items-center">
                    <i class="pi pi-palette" id="divider-icon"/>
                    <b>Mi tema preferido</b>
                </div>
            </p:divider>
            <div class="theme-selector-container" style="margin-bottom:1rem;">
                <h:form id="themeForm">
                    <p:selectOneMenu id="themeSelect"
                                     value="#{userBackingBean.tema}">
                        <f:selectItem itemLabel="Claro"  itemValue="light"/>
                        <f:selectItem itemLabel="Oscuro" itemValue="dark"/>
                        <f:selectItem itemLabel="Verde"  itemValue="green"/>
                        <f:selectItem itemLabel="Rosa"   itemValue="pink"/>
                        
                        <p:ajax listener="#{userClientBean.guardarTema}" update="@all" global="true"/>
                    </p:selectOneMenu>
                </h:form>
            </div>
        </div>
    </h:body>
</html>